<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>โปรแกรมดึงข้อความจากภาพ (OCR) — iPhone 17 Pro Max</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet"/>

  <!-- React & ReactDOM (ต้องมาก่อน lucide-react) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Lucide Icons (UMD -> window.lucideReact บางบิลด์มี window.lucide) -->
  <script src="https://unpkg.com/lucide-react@0.294.0/dist/lucide-react.js"></script>

  <!-- Tesseract.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    body{
      font-family:'Sarabun',sans-serif;
      background: linear-gradient(135deg, #ff8a00 0%, #ff3d00 100%);
      min-height:100vh;
      display:flex;align-items:center;justify-content:center;
      padding:16px;
    }
    /* iPhone 17 Pro Max frame */
    .iphone{ width:430px;height:932px;border-radius:48px;background:#0b0b0b;position:relative;overflow:hidden;
      box-shadow:0 10px 40px rgba(0,0,0,.5),0 0 0 10px #1c1c1c,inset 0 0 0 2px #000;}
    .bezel{ position:absolute; inset:10px; border-radius:38px; background:#000; overflow:hidden;}
    .island{ position:absolute; left:50%; top:12px; transform:translateX(-50%); width:168px;height:36px;border-radius:20px;background:#000; box-shadow:0 2px 8px rgba(0,0,0,.35); z-index:5;}
    .screen{ position:absolute; inset:10px; border-radius:38px; background:linear-gradient(180deg,#fffaf6 0%,#fff 30%,#fff 100%); overflow:hidden;}
    /* ให้ไอคอนรับสีจาก currentColor เสมอ */
    svg.lucide{ stroke: currentColor; }

    /* Loader */
    .loader{ border:4px solid rgba(255,255,255,.3); border-top:4px solid #fff; border-radius:50%; width:50px;height:50px; animation:spin 1s linear infinite;}
    @keyframes spin{ 0%{transform:rotate(0deg)}100%{transform:rotate(360deg)} }

    /* Scrollbar ภายในแอป */
    .app ::-webkit-scrollbar{ width:8px; }
    .app ::-webkit-scrollbar-track{ background:#f1f1f1; border-radius:10px; }
    .app ::-webkit-scrollbar-thumb{ background:#fb923c; border-radius:10px; }
    .app ::-webkit-scrollbar-thumb:hover{ background:#f97316; }
  </style>
</head>
<body>

  <!-- iPhone Frame -->
  <div class="iphone">
    <div class="island"></div>
    <div class="bezel">
      <div class="screen app">
        <!-- เนื้อหาแอป -->
        <div class="min-h-full w-full h-full overflow-y-auto bg-gradient-to-b from-orange-50 to-white p-4">

          <!-- Card หลัก -->
          <div class="bg-white/90 backdrop-blur-sm shadow-2xl rounded-3xl p-6 md:p-8 w-full space-y-6">

            <!-- Header -->
            <div class="text-center">
              <div id="icon-container-header" class="inline-block bg-orange-100 p-3 rounded-full shadow-lg -mt-4 mb-4"></div>
              <h1 class="text-3xl md:text-4xl font-bold text-orange-700">โปรแกรมดึงข้อความจากภาพ</h1>
              <p class="text-gray-500 mt-2">อัปโหลดภาพเพื่อเริ่มการแปลงข้อความ</p>
            </div>

            <!-- อัปโหลดภาพ -->
            <div class="space-y-4">
              <label for="image-input" class="w-full flex flex-col items-center justify-center p-6 border-2 border-dashed border-orange-400 rounded-2xl cursor-pointer hover:bg-orange-50 transition-colors duration-300">
                <div id="icon-container-upload" class="mb-3"></div>
                <span class="font-semibold text-orange-700">เลือกรูปภาพ</span>
                <p class="text-xs text-gray-500 mt-1">รองรับไฟล์ PNG, JPG, BMP</p>
              </label>
              <input type="file" id="image-input" accept="image/*" class="hidden">

              <!-- Preview -->
              <div id="image-preview-container" class="hidden w-full max-h-64 overflow-hidden rounded-xl shadow-inner bg-gray-100">
                <img id="preview-image" src="#" alt="ตัวอย่างภาพ" class="w-full h-full object-contain">
              </div>
            </div>

            <!-- ปุ่มทำงาน -->
            <div class="flex flex-col sm:flex-row gap-4">
              <button id="extract-btn" disabled class="flex-1 flex items-center justify-center gap-2 bg-orange-600 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:bg-orange-700 transition-all duration-300 transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
                <div id="icon-container-scan"></div>
                <span>ดึงข้อความ</span>
              </button>
            </div>

            <!-- ผลลัพธ์ -->
            <div>
              <label for="result-text" class="block text-sm font-medium text-gray-700 mb-2">ข้อความที่ได้:</label>
              <textarea id="result-text" rows="6" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-shadow duration-200" placeholder="ผลลัพธ์จะแสดงที่นี่..."></textarea>
              <button id="save-btn" disabled class="mt-3 w-full flex items-center justify-center gap-2 bg-orange-500 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:bg-orange-600 transition-all duration-300 transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
                <div id="icon-container-save"></div>
                <span>บันทึกลงประวัติ</span>
              </button>
            </div>

            <!-- ประวัติ -->
            <div class="pt-6 border-t border-gray-200">
              <h2 class="text-2xl font-bold text-orange-700 mb-4 text-center">ประวัติการบันทึก</h2>
              <div id="history-container" class="max-h-80 overflow-y-auto bg-white p-4 rounded-xl shadow-inner space-y-3">
                <table class="w-full text-sm text-left text-gray-600">
                  <thead class="text-xs text-orange-800 uppercase bg-orange-100 sticky top-0">
                    <tr>
                      <th scope="col" class="px-4 py-3 rounded-l-lg">วันที่</th>
                      <th scope="col" class="px-4 py-3">เนื้อหา</th>
                      <th scope="col" class="px-4 py-3 rounded-r-lg text-center">จัดการ</th>
                    </tr>
                  </thead>
                  <tbody id="history-body">
                    <!-- rows by JS -->
                  </tbody>
                </table>
                <p id="no-history-text" class="text-center text-gray-500 hidden">ยังไม่มีประวัติการบันทึก</p>
              </div>
            </div>

          </div>
          <!-- /Card -->
        </div>
        <!-- /เนื้อหาแอป -->
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loader" class="fixed inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center z-50 hidden">
    <div class="loader"></div>
    <p id="loader-text" class="text-white text-lg mt-4">กำลังประมวลผล...</p>
  </div>

  <!-- Popup -->
  <div id="popup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center transform transition-all duration-200 scale-95 opacity-0" id="popup-content">
      <div id="popup-icon" class="mx-auto mb-4"></div>
      <h3 id="popup-title" class="text-xl font-bold text-gray-800"></h3>
      <p id="popup-message" class="text-gray-600 mt-2 mb-6"></p>
      <button id="popup-close-btn" class="bg-orange-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-orange-700 transition-colors duration-300">ตกลง</button>
    </div>
  </div>

  <script type="module">
    // ===== Utilities (Lucide helper) =====
    function getLucideLib(){ return window.lucideReact || window.lucide || null; }

    // ===== Render static icons =====
    const R = React, RD = ReactDOM;
    function renderIcon(containerId, iconName, props={size:24, className:''}){
      const el = document.getElementById(containerId);
      const lib = getLucideLib();
      if (el && lib && lib[iconName]) RD.render(R.createElement(lib[iconName], props), el);
    }
    renderIcon('icon-container-header','ScanText',{size:32});      // ไม่ใส่สี
    renderIcon('icon-container-upload','UploadCloud',{size:40});   // ไม่ใส่สี
    renderIcon('icon-container-scan','Scan',{size:20});            // ไม่ใส่สี
    renderIcon('icon-container-save','Save',{size:20});            // ไม่ใส่สี

    // ===== Elements =====
    const imageInput = document.getElementById('image-input');
    const previewImage = document.getElementById('preview-image');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const extractBtn = document.getElementById('extract-btn');
    const saveBtn = document.getElementById('save-btn');
    const resultText = document.getElementById('result-text');
    const historyBody = document.getElementById('history-body');
    const noHistoryText = document.getElementById('no-history-text');
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');

    // Popup
    const popup = document.getElementById('popup');
    const popupContent = document.getElementById('popup-content');
    const popupIcon = document.getElementById('popup-icon');
    const popupTitle = document.getElementById('popup-title');
    const popupMessage = document.getElementById('popup-message');
    const popupCloseBtn = document.getElementById('popup-close-btn');

    // ===== State =====
    let history = [];

    // ===== UI Helpers =====
    function showLoader(show, text='กำลังประมวลผล...'){
      loaderText.textContent = text;
      extractBtn.setAttribute('aria-busy', show ? 'true':'false');
      loader.classList.toggle('hidden', !show);
    }

    function showPopup(title, message, type='info'){
      popupTitle.textContent = title;
      popupMessage.textContent = message;

      let iconName='Info';
      if (type==='success') iconName='CheckCircle2';
      else if (type==='error') iconName='XCircle';

      const lib = getLucideLib();
      if (lib && lib[iconName]){
        RD.render(R.createElement(lib[iconName], {size:48}), popupIcon); // ไม่ใส่สี
      }
      popup.classList.remove('hidden');
      setTimeout(()=>{ popupContent.classList.replace('scale-95','scale-100'); popupContent.classList.replace('opacity-0','opacity-100'); },10);
    }

    function renderHistory(){
      historyBody.innerHTML='';
      if (history.length===0){ noHistoryText.classList.remove('hidden'); return; }
      noHistoryText.classList.add('hidden');

      const lib = getLucideLib();

      history.forEach((item, index)=>{
        const tr = document.createElement('tr');
        tr.className='bg-white border-b hover:bg-gray-50';

        const dateTd = document.createElement('td');
        dateTd.className='px-4 py-3 text-gray-600 whitespace-nowrap';
        dateTd.textContent = new Date(item.date).toLocaleDateString('th-TH',{day:'numeric',month:'short',year:'numeric'});

        const textTd = document.createElement('td');
        textTd.className='px-4 py-3 text-gray-800';
        textTd.innerHTML = `<p class="truncate max-w-xs" title="${item.text.replace(/"/g,'&quot;')}">${item.text}</p>`;

        const actionTd = document.createElement('td');
        actionTd.className='px-4 py-3 flex justify-center items-center gap-2';

        // ปุ่มดินสอ + ถังขยะ (ไม่ส่ง className/color)
        const editBtn = document.createElement('button');
        editBtn.dataset.index = index;
        editBtn.className='p-1 rounded-full hover:bg-gray-100';
        editBtn.addEventListener('click', handleEdit);

        const deleteBtn = document.createElement('button');
        deleteBtn.dataset.index = index;
        deleteBtn.className='p-1 rounded-full hover:bg-gray-100';
        deleteBtn.addEventListener('click', handleDelete);

        if (lib){
          RD.render(React.createElement(lib.Pencil, {size:18}), editBtn);
          RD.render(React.createElement(lib.Trash2, {size:18}), deleteBtn);
        }

        actionTd.appendChild(editBtn);
        actionTd.appendChild(deleteBtn);

        tr.appendChild(dateTd);
        tr.appendChild(textTd);
        tr.appendChild(actionTd);
        historyBody.appendChild(tr);
      });
    }

    function saveHistoryToStorage(){ localStorage.setItem('ocrHistory', JSON.stringify(history)); }
    function loadHistoryFromStorage(){
      const stored = localStorage.getItem('ocrHistory');
      if (stored){ history = JSON.parse(stored); renderHistory(); }
      else { noHistoryText.classList.remove('hidden'); }
    }
    function resetUI(){
      imageInput.value=''; previewImage.src='#'; imagePreviewContainer.classList.add('hidden');
      resultText.value=''; extractBtn.disabled=true; saveBtn.disabled=true;
    }

    // ===== Events =====
    imageInput.addEventListener('change', (event)=>{
      const file = event.target.files[0];
      if (!file) return;
      if (!(file.type && file.type.startsWith('image/'))){
        showPopup('ไฟล์ไม่ถูกต้อง','กรุณาเลือกไฟล์รูปภาพเท่านั้น (PNG, JPG, BMP)','error');
        imageInput.value=''; return;
      }
      const reader = new FileReader();
      reader.onload = (e)=>{
        previewImage.src = e.target.result;
        imagePreviewContainer.classList.remove('hidden');
        extractBtn.disabled=false; saveBtn.disabled=true; resultText.value='';
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('extract-btn').addEventListener('click', async ()=>{
      if (!previewImage.src || previewImage.src.endsWith('#')){
        showPopup('ผิดพลาด','กรุณาเลือกรูปภาพก่อน','error'); return;
      }
      showLoader(true,'กำลังอ่านข้อความ...');
      try{
        const { data:{ text } } = await Tesseract.recognize(
          previewImage.src,'tha+eng',
          { logger: m=>{ if(m.status==='recognizing text'){ loaderText.textContent=`กำลังประมวลผล... (${Math.round(m.progress*100)}%)`; } } }
        );
        resultText.value = text;
        saveBtn.disabled = text.trim().length===0;
        showLoader(false);
        if (text.trim().length>0) showPopup('สำเร็จ','ดึงข้อความจากภาพเรียบร้อยแล้ว','success');
        else showPopup('ไม่พบข้อความ','ไม่พบข้อความที่สามารถอ่านได้ในรูปภาพ','info');
      }catch(err){
        console.error('OCR Error:',err);
        showLoader(false);
        showPopup('เกิดข้อผิดพลาด','ไม่สามารถดึงข้อความจากภาพได้ กรุณาลองใหม่','error');
      }
    });

    document.getElementById('save-btn').addEventListener('click', ()=>{
      const textToSave = resultText.value.trim();
      if (textToSave){
        history.unshift({ text: textToSave, date: new Date() });
        saveHistoryToStorage(); renderHistory(); resetUI();
        showPopup('บันทึกสำเร็จ','ข้อมูลถูกบันทึกลงในประวัติแล้ว','success');
      }else{
        showPopup('คำเตือน','ไม่มีข้อความให้บันทึก','info');
      }
    });

    popupCloseBtn.addEventListener('click', ()=>{
      popupContent.classList.add('scale-95','opacity-0'); popupContent.classList.remove('scale-100','opacity-100');
      setTimeout(()=>popup.classList.add('hidden'),200);
    });

    function handleEdit(event){
      const index = event.currentTarget.getAttribute('data-index');
      const item = history[index];
      resultText.value = item.text; resultText.focus(); saveBtn.disabled=false;
      history.splice(index,1); saveHistoryToStorage(); renderHistory();
      showPopup('กำลังแก้ไข','แก้ไขข้อความในกล่องด้านบน แล้วกดบันทึกอีกครั้ง','info');
    }
    function handleDelete(event){
      const index = event.currentTarget.getAttribute('data-index');
      history.splice(index,1); saveHistoryToStorage(); renderHistory();
    }

    // ===== Initial load =====
    loadHistoryFromStorage();
  </script>
</body>
</html>
